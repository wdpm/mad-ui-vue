<!DOCTYPE html>
<html lang="en">
<head>
    <title>Fireflies</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
        body {
            background-color: rgba(0, 0, 0, .8);
            text-align: center;
        }

        canvas {
            border: 1px solid white;
        }
    </style>
</head>
<body>
<canvas id="canvas"></canvas>
<!--<script src='//code.jquery.com/jquery-3.1.1.min.js'></script>-->
<script>
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let fireFlies = [];
    let fireFlyCount = 50;

    function init() {
        for (let i = 0; i < fireFlyCount; i++) {
            fireFlies[i] = new Circle();
        }
    }

    function animate() {
        requestAnimationFrame(animate)
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < fireFlies.length; i++) {
            fireFlies[i].update();
        }
    }

    class Circle {
        // config options
        config = {
            //half life，which is used to calculate the half-life of each particle
            halfLife: 160,

            // xMaxSpeed and yMaxSpeed define the maximum number of pixels a particle can move each frame.
            xMaxSpeed: 5,
            yMaxSpeed: 2,

            // radiusMax is the maximum radius a particle can achieve. This defines the maximum size a firefly can glow.
            radiusMax: 4,

            // ratio is used in conjunction with hl to
            // determine the ratio of maximum speed and full opacity of each particle in each frame.
            ratio: 1,

            // xDrift, yDrift are values which will be use for the particles movement.
            xDrift: 4,
            yDrift: 4,

            // random:true means its going to be random and blink:true means its going to blink.
            random: true,
            blink: true,
        };

        constructor() {
            this.reset();
        }

        reset() {
            this.x = canvas.width * Math.random();
            this.y = canvas.height * Math.random();
            this.radius = (Math.random() * this.config.radiusMax) + 4;//[0,4) +4 => [4,8)
            this.dx = (Math.random() * this.config.xMaxSpeed) * (Math.random() < .5 ? -1 : 1);
            this.dy = (Math.random() * this.config.yMaxSpeed) * (Math.random() < .5 ? -1 : 1);
            this.ratio = Math.random() * this.config.halfLife;//[0,160)

            this.config.ratio = Math.random() + 1;//[1,2)
            this.config.xDrift *= Math.random() * (Math.random() < .5 ? -1 : 1);//[0,1) or (-1,0]
            this.config.yDrift *= Math.random() * (Math.random() < .5 ? -1 : 1);
        }

        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, true);
            ctx.closePath();

            let proportion = 1 - (this.ratio / this.config.halfLife);//(0,1)
            let cr = this.radius * proportion;
            let gradient = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, (cr <= 0 ? 1 : cr));
            gradient.addColorStop(0.0, 'rgba(253,219,163,' + proportion + ')');
            let middleStop = Math.random() * .2 + .4;
            let alpha = proportion * 0.2;
            gradient.addColorStop(middleStop, 'rgba(238,180,28,' + alpha + ')');
            gradient.addColorStop(1.0, 'rgba(253,219,163,0)');
            ctx.fillStyle = gradient;
            ctx.fill();
        }

        update() {
            // This adds the value of ratio to the object this.config ratio’s attribute.
            // By doing this, the ratio to the half-life increases, making our firefly go dim and dimmer.
            this.ratio += this.config.ratio;

            let proportion = this.ratio / this.config.halfLife;
            this.x += proportion * this.dx;
            this.y += proportion * this.dy;

            if (this.x > canvas.width || this.x < 0) this.dx *= -1;
            if (this.y > canvas.height || this.y < 0) this.dy *= -1;

            // here invariants: ratio < halfLife
            if (this.config.blink && (this.ratio <= 0 || this.ratio >= this.config.halfLife)) {
                this.config.ratio *= -1;
            } else if (this.ratio >= this.config.halfLife) {
                this.reset();
            }

            this.draw();
        }
    }

    init()

    animate()
</script>
</body>
</html>
